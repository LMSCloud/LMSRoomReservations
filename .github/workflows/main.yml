name: CI
on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 6 * * *"
jobs:
  js_tests:
    name: Run JS/TS unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm test

  perl_tests:
    name: Run Perl integration tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Get Koha stable branch
      id: koha-version
      uses: "bywatersolutions/github-action-koha-get-version-by-label@master"
      with:
        version-label: stable

    - name: Check out Koha
      run: |
        cd ..
        git clone --branch ${{ steps.koha-version.outputs.current-branch-name }} --single-branch --depth 1 https://github.com/Koha-Community/Koha.git koha

    - name: Set up koha-testing-docker
      run: |
        sudo sysctl -w vm.max_map_count=262144
        IFS='/' read -r -a parts <<< "$GITHUB_REPOSITORY"
        export GITHUB_REPO="${parts[1]}"
        export SYNC_REPO="$(cd .. && pwd)/koha"
        export LOCAL_USER_ID="$(id -u)"
        export KOHA_INTRANET_URL="http://127.0.0.1:8081"
        export KOHA_MARC_FLAVOUR="marc21"
        export RUN_TESTS_AND_EXIT="no"
        export KOHA_IMAGE="main"
        echo "GITHUB_REPO=$GITHUB_REPO" >> "$GITHUB_ENV"
        echo "SYNC_REPO=$SYNC_REPO" >> "$GITHUB_ENV"
        echo "LOCAL_USER_ID=$LOCAL_USER_ID" >> "$GITHUB_ENV"
        echo "KOHA_INTRANET_URL=$KOHA_INTRANET_URL" >> "$GITHUB_ENV"
        echo "KOHA_MARC_FLAVOUR=$KOHA_MARC_FLAVOUR" >> "$GITHUB_ENV"
        echo "RUN_TESTS_AND_EXIT=$RUN_TESTS_AND_EXIT" >> "$GITHUB_ENV"
        echo "KOHA_IMAGE=$KOHA_IMAGE" >> "$GITHUB_ENV"
        wget -O docker-compose.yml https://gitlab.com/koha-community/koha-testing-docker/-/raw/main/docker-compose.yml
        mkdir -p env
        wget -O env/defaults.env https://gitlab.com/koha-community/koha-testing-docker/-/raw/main/env/defaults.env
        cp env/defaults.env .env
        echo "CACHE_DATE=$(date +%Y-%m-%d)" >> "$GITHUB_ENV"

    - name: Restore Docker image cache
      id: docker-cache
      uses: actions/cache/restore@v4
      with:
        path: /tmp/docker-images
        key: docker-koha-${{ env.CACHE_DATE }}-${{ hashFiles('docker-compose.yml') }}

    - name: Load cached Docker images
      if: steps.docker-cache.outputs.cache-hit == 'true'
      run: docker load -i /tmp/docker-images/images.tar

    - name: Pull Docker images
      if: steps.docker-cache.outputs.cache-hit != 'true'
      run: |
        docker compose pull
        mkdir -p /tmp/docker-images
        docker save $(docker compose config --images) -o /tmp/docker-images/images.tar

    - name: Save Docker image cache
      if: always() && steps.docker-cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: /tmp/docker-images
        key: docker-koha-${{ env.CACHE_DATE }}-${{ hashFiles('docker-compose.yml') }}

    - name: Start Koha services
      run: |
        docker compose -f docker-compose.yml -p koha up --detach
        docker compose -p koha exec koha apt-get install -y libyaml-syck-perl libemail-valid-perl libmojo-jwt-perl 2>/dev/null || true

    - name: Wait for Koha to be ready
      run: |
        echo "Waiting for Koha services to initialize..."
        for i in $(seq 1 60); do
          if docker compose -p koha exec -T koha perl -e '
            use C4::Context;
            my $dbh = C4::Context->dbh or die;
            $dbh->selectrow_array("SELECT 1 FROM systempreferences LIMIT 1") or die;
          ' 2>/dev/null; then
            echo "Koha is ready after ~${i}0 seconds."
            break
          fi
          sleep 10
        done

    - name: Copy plugin and run tests
      run: |
        docker cp . "$(docker compose -p koha ps -q koha)":/var/lib/koha/kohadev/plugins
        docker compose -p koha exec koha /kohadevbox/koha/misc/devel/install_plugins.pl
        docker compose -p koha exec koha bash -c 'prove -v /var/lib/koha/kohadev/plugins/t'

    - name: Show logs on failure
      if: failure()
      run: docker compose -p koha logs koha 2>&1 | tail -100

    - name: Cleanup
      if: always()
      run: |
        docker compose -p koha down -v 2>/dev/null || true

  unit_tests:
    name: Run multi-version compatibility tests
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        koha-version: [master, stable, oldstable]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Get Koha Version Branch Name
      id: koha-version
      uses: "bywatersolutions/github-action-koha-get-version-by-label@master"
      with:
        version-label: "${{ matrix.koha-version }}"

    - name: Check out Koha
      run: |
        cd ..
        git clone --branch ${{ steps.koha-version.outputs.current-branch-name }} --single-branch --depth 1 https://github.com/Koha-Community/Koha.git koha

    - name: Set up koha-testing-docker
      run: |
        sudo sysctl -w vm.max_map_count=262144
        IFS='/' read -r -a parts <<< "$GITHUB_REPOSITORY"
        export GITHUB_REPO="${parts[1]}"
        export SYNC_REPO="$(cd .. && pwd)/koha"
        export LOCAL_USER_ID="$(id -u)"
        export KOHA_INTRANET_URL="http://127.0.0.1:8081"
        export KOHA_MARC_FLAVOUR="marc21"
        export RUN_TESTS_AND_EXIT="no"
        export KOHA_IMAGE="main"
        echo "GITHUB_REPO=$GITHUB_REPO" >> "$GITHUB_ENV"
        echo "SYNC_REPO=$SYNC_REPO" >> "$GITHUB_ENV"
        echo "LOCAL_USER_ID=$LOCAL_USER_ID" >> "$GITHUB_ENV"
        echo "KOHA_INTRANET_URL=$KOHA_INTRANET_URL" >> "$GITHUB_ENV"
        echo "KOHA_MARC_FLAVOUR=$KOHA_MARC_FLAVOUR" >> "$GITHUB_ENV"
        echo "RUN_TESTS_AND_EXIT=$RUN_TESTS_AND_EXIT" >> "$GITHUB_ENV"
        echo "KOHA_IMAGE=$KOHA_IMAGE" >> "$GITHUB_ENV"
        wget -O docker-compose.yml https://gitlab.com/koha-community/koha-testing-docker/-/raw/main/docker-compose.yml
        mkdir -p env
        wget -O env/defaults.env https://gitlab.com/koha-community/koha-testing-docker/-/raw/main/env/defaults.env
        cp env/defaults.env .env
        echo "CACHE_DATE=$(date +%Y-%m-%d)" >> "$GITHUB_ENV"

    - name: Restore Docker image cache
      id: docker-cache
      uses: actions/cache/restore@v4
      with:
        path: /tmp/docker-images
        key: docker-koha-${{ env.CACHE_DATE }}-${{ hashFiles('docker-compose.yml') }}

    - name: Load cached Docker images
      if: steps.docker-cache.outputs.cache-hit == 'true'
      run: docker load -i /tmp/docker-images/images.tar

    - name: Pull Docker images
      if: steps.docker-cache.outputs.cache-hit != 'true'
      run: |
        docker compose pull
        mkdir -p /tmp/docker-images
        docker save $(docker compose config --images) -o /tmp/docker-images/images.tar

    - name: Save Docker image cache
      if: always() && steps.docker-cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: /tmp/docker-images
        key: docker-koha-${{ env.CACHE_DATE }}-${{ hashFiles('docker-compose.yml') }}

    - name: Start Koha services
      run: |
        docker compose -f docker-compose.yml -p koha up --detach
        docker compose -p koha exec koha apt-get install -y libyaml-syck-perl libemail-valid-perl libmojo-jwt-perl 2>/dev/null || true

    - name: Wait for Koha to be ready
      run: |
        echo "Waiting for Koha services to initialize..."
        for i in $(seq 1 60); do
          if docker compose -p koha exec -T koha perl -e '
            use C4::Context;
            my $dbh = C4::Context->dbh or die;
            $dbh->selectrow_array("SELECT 1 FROM systempreferences LIMIT 1") or die;
          ' 2>/dev/null; then
            echo "Koha is ready after ~${i}0 seconds."
            break
          fi
          sleep 10
        done

    - name: Copy plugin and run tests
      run: |
        docker cp . "$(docker compose -p koha ps -q koha)":/var/lib/koha/kohadev/plugins
        docker compose -p koha exec koha /kohadevbox/koha/misc/devel/install_plugins.pl
        docker compose -p koha exec koha bash -c 'prove -v /var/lib/koha/kohadev/plugins/t'

    - name: Show logs on failure
      if: failure()
      run: docker compose -p koha logs koha 2>&1 | tail -100

    - name: Cleanup
      if: always()
      run: |
        docker compose -p koha down -v 2>/dev/null || true

  release:
    name: Build & Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [perl_tests, unit_tests]
    strategy:
      fail-fast: false
    steps:
    - uses: actions/checkout@v1

    - name: Parse out and store the GitHub repository name
      id: myvars
      run: |
        IFS='/' read -r -a parts <<< "$GITHUB_REPOSITORY"
        GITHUB_REPO="${parts[1]}"
        echo ::set-output name=github_repo::$GITHUB_REPO
        echo "GITHUB REPO: $GITHUB_REPO"

        TAG_VERSION="${GITHUB_REF##*/}"
        echo "TAG VERSION: $TAG_VERSION"
        TAG_VERSION="${TAG_VERSION:1}"
        echo "TAG VERSION 2: $TAG_VERSION"
        echo ::set-output name=tag_version::$TAG_VERSION

    - name: Get Koha Version Branch Name
      id: koha-version-oldstable
      uses: "bywatersolutions/github-action-koha-get-version-by-label@master"
      with:
        version-label: "oldstable"

    - name: Print minimum version
      run: |
        echo "Current oldstable version: ${{ steps.koha-version-oldstable.outputs.version-major-minor }}"

    - name: Dump myvars outputs
      env:
        GITHUB_CONTEXT: ${{ toJson(steps.myvars.outputs) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Build Koha Plugin kpz artifact
      id: kpz
      uses: "bywatersolutions/github-action-koha-plugin-create-kpz@master"
      with:
        release-version: ${{ steps.myvars.outputs.tag_version }}
        release-name: ${{ steps.myvars.outputs.github_repo }}
        minimum-version: ${{ steps.koha-version-oldstable.outputs.version-major-minor }}
        plugin-module: "Koha/Plugin/Com/LMSCloud/RoomReservations.pm"

    - name: See if kpz was created
      run: |
        echo "FILENAME: ${{ steps.kpz.outputs.filename }}"
        ls -alh

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          ${{ steps.kpz.outputs.filename }}
          CHANGELOG.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  keepalive:
    name: Keep Alive
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Check age and push commit if needed
      run: |
        LAST_COMMIT=$( git --no-pager log -1 --format=%ct )
        NOW=$(date +%s)
        DIFF=$(($NOW-$LAST_COMMIT))
        DAYS=$(($DIFF/86400))
        git config --global user.email kyle@bywatersolutions.com
        git config --global user.name "Kyle M Hall"
        git commit --allow-empty -m "Automated commit from keep alive workflow"
        if [ "$DAYS" -gt "50" ]; then git push; fi